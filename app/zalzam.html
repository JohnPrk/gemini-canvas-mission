<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì˜ì  - Jal-Jam: 3D ìˆ˜ë©´ ë¹„ì„œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');

    :root {
      --bg-deep: #020617;
      --indigo-primary: #6366f1;
      --indigo-light: #818cf8;
      --card-glass: rgba(255, 255, 255, 0.04);
      --report-paper: #ffffff;
    }

    body {
      font-family: 'Pretendard', sans-serif;
      background-color: #000;
      color: white;
      margin: 0;
      padding: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      max-width: 480px;
      background-color: var(--bg-deep);
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 60px rgba(0,0,0,1);
    }

    /* Fixed Header */
    .app-header {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 110;
      background: rgba(2, 6, 23, 0.7);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Main Viewport */
    .scroll-view {
      flex: 1;
      overflow-y: auto;
      padding-top: 64px;
      padding-bottom: 100px;
      scrollbar-width: none;
    }
    .scroll-view::-webkit-scrollbar { display: none; }

    .tab-content { display: none; min-height: 100%; width: 100%; position: relative; }
    .tab-content.active { display: block; }

    /* Fullscreen Overlays */
    #onboarding, #tab-log {
      position: fixed;
      inset: 0;
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      z-index: 200;
      background-color: var(--bg-deep);
      display: flex;
      flex-direction: column;
      padding: 32px;
    }

    /* 3D Viewport */
    #main-3d-container {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 0;
    }

    /* UI Cards */
    .glass-card {
      background: var(--card-glass);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 32px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .btn-main {
      background: var(--indigo-primary);
      color: white;
      font-weight: 800;
      padding: 18px;
      border-radius: 24px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-main:active { transform: scale(0.95); opacity: 0.9; }

    /* Step Log Flow */
    .log-step { display: none; flex-direction: column; height: 100%; padding-top: 80px; }
    .log-step.active { display: flex; animation: slideUp 0.5s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

    /* Chart Section - Refined Size and Visibility */
    .chart-container {
      height: 180px; /* Increased height */
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      align-items: flex-end;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 5px;
    }
    .chart-bar {
      width: 100%;
      border-radius: 8px 8px 4px 4px;
      background: linear-gradient(to top, var(--indigo-primary), var(--indigo-light));
      position: relative;
      min-height: 4px;
      box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
    }
    .chart-bar-val {
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      font-weight: 800;
      color: var(--indigo-light);
      white-space: nowrap;
    }
    .chart-bar-empty { height: 4px; background: rgba(255,255,255,0.05); border-radius: 4px; }

    .fatigue-item {
      flex: 1;
      padding: 16px 4px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      transition: 0.3s;
    }
    .fatigue-item.active {
      background: rgba(99, 102, 241, 0.15);
      border-color: var(--indigo-primary);
      transform: translateY(-4px);
    }

    /* Modern Report Style */
    .modern-report {
      background: var(--report-paper);
      color: #1e293b;
      padding: 32px;
      border-radius: 32px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.4);
      position: relative;
      animation: reportFadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes reportFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

    .report-label { display: inline-block; padding: 4px 12px; background: #f1f5f9; border-radius: 10px; font-size: 10px; font-weight: 800; color: #64748b; margin-bottom: 16px; }

    /* Loading Animation */
    .ai-loading { display: none; align-items: center; justify-content: center; flex-direction: column; gap: 20px; padding: 40px 0; }
    .ai-loading.active { display: flex; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(99, 102, 241, 0.1); border-top-color: var(--indigo-primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Navigation */
    nav {
      position: absolute;
      bottom: 0; left: 0; right: 0; height: 90px;
      background: rgba(2, 6, 23, 0.9);
      backdrop-filter: blur(25px);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      z-index: 100;
    }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #475569; font-weight: 800; font-size: 10px; transition: 0.3s; cursor: pointer; }
    .nav-item.active { color: var(--indigo-light); }

    body.is-recording nav { display: none !important; }

    /* Chat UI */
    .chat-container { height: 380px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding: 10px; scroll-behavior: smooth; }
    .chat-bubble { max-width: 80%; padding: 16px 20px; border-radius: 20px; font-size: 0.9rem; line-height: 1.6; }
    .chat-bubble.ai { align-self: flex-start; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.05); }
    .chat-bubble.user { align-self: flex-end; background: var(--indigo-primary); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2); }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="app">

  <!-- Header -->
  <header class="app-header">
    <div class="flex items-center gap-2">
      <span class="text-xl">ğŸŒ™</span>
      <span class="text-lg font-black tracking-tight">ì˜ì </span>
    </div>
    <div id="userBadge" class="flex items-center gap-2 bg-white/5 px-4 py-1.5 rounded-full border border-white/5">
      <span id="headerName" class="text-[10px] font-black text-indigo-300">ì‚¬ìš©ì</span>
      <div class="w-1 h-1 bg-green-500 rounded-full animate-pulse"></div>
    </div>
  </header>

  <!-- Onboarding (Login) -->
  <div id="onboarding">
    <div class="text-center mb-12">
      <div class="w-24 h-24 bg-indigo-600 rounded-[2.5rem] mx-auto mb-8 flex items-center justify-center shadow-2xl shadow-indigo-600/30">
        <span class="text-5xl">ğŸ’¤</span>
      </div>
      <h1 class="text-4xl font-black mb-3">ì•ˆë…•í•˜ì„¸ìš”!</h1>
      <p class="text-slate-400 text-sm leading-relaxed">ë‹¹ì‹ ì˜ ìˆ˜ë©´ì„ ì—°êµ¬í•˜ëŠ”<br>ê°€ì¥ ë˜‘ë˜‘í•œ ë¹„ì„œ, ì˜ì ì…ë‹ˆë‹¤.</p>
    </div>

    <div class="space-y-4 mb-14">
      <input id="userNameIn" type="text" placeholder="ì´ë¦„" class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl outline-none focus:border-indigo-500 text-white font-bold text-center">
      <input id="userAgeIn" type="number" placeholder="ë‚˜ì´" class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl outline-none focus:border-indigo-500 text-white font-bold text-center">
      <div class="flex gap-3">
        <button onclick="selectGender('male')" id="gBtn-male" class="flex-1 p-4 rounded-2xl bg-white/5 border border-white/10 font-bold text-slate-500 transition text-sm">ë‚¨ì„±</button>
        <button onclick="selectGender('female')" id="gBtn-female" class="flex-1 p-4 rounded-2xl bg-white/5 border border-white/10 font-bold text-slate-500 transition text-sm">ì—¬ì„±</button>
      </div>
    </div>
    <button onclick="submitLogin()" class="btn-main">ì‹œì‘í•˜ê¸°</button>
  </div>

  <!-- Main Scroll Area -->
  <main class="scroll-view">

    <!-- Tab: Home -->
    <div id="tab-home" class="tab-content active h-full">
      <div id="main-3d-container"></div>

      <div class="relative z-10 p-6 flex flex-col h-full pointer-events-none">
        <div class="mt-6">
          <h2 id="homeDateLabel" class="text-2xl font-black text-white drop-shadow-2xl">2026ë…„ 2ì›” 26ì¼</h2>
          <p id="envLabel" class="text-sm text-indigo-300 font-bold mt-1">í¬ê·¼í•œ íœ´ì‹ì´ í•„ìš”í•œ ì‹œê°„ì…ë‹ˆë‹¤.</p>
        </div>

        <div class="mt-auto pointer-events-auto">
          <div class="glass-card flex flex-col gap-5">
            <div class="flex justify-between items-end">
              <div>
                <p class="text-[10px] text-slate-500 font-black uppercase mb-1">ìˆ˜ë©´ ì‹œê°„</p>
                <span id="hHoursDisplay" class="text-4xl font-black text-white">0.0H</span>
              </div>
              <div class="text-right">
                <p class="text-[10px] text-slate-500 font-black uppercase mb-1">ë‚˜ì˜ ì»¨ë””ì…˜</p>
                <span id="hEmojiDisplay" class="text-3xl">--</span>
              </div>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-white/5">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-indigo-500 rounded-full animate-ping"></div>
                <span id="hTagDisplay" class="text-[10px] font-black text-indigo-200 tracking-wider uppercase">#ê¸°ë¡ ëŒ€ê¸°ì¤‘</span>
              </div>
              <button onclick="switchTab('log')" class="text-[10px] font-black text-slate-500 hover:text-white transition">ê¸°ë¡ ì—…ë°ì´íŠ¸ &gt;</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Weekly Stats & AI Chat -->
    <div id="tab-weekly" class="tab-content p-6">
      <h2 class="text-2xl font-black mb-8">ìˆ˜ë©´ í†µê³„</h2>

      <div class="glass-card mb-8">
        <div class="flex justify-between items-center mb-8">
          <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest">ì£¼ê°„ ì°¨íŠ¸</h3>
          <span id="weekRange" class="text-[10px] font-black text-indigo-400 bg-indigo-400/10 px-3 py-1 rounded-full"></span>
        </div>
        <div id="weeklyChartArea" class="chart-container mb-4"></div>
        <div class="grid grid-cols-7 gap-2 text-center text-[10px] font-black text-slate-600">
          <span>ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span>
        </div>
      </div>

      <div class="glass-card min-h-[480px] flex flex-col">
        <div class="flex items-center justify-between mb-8">
          <h3 class="text-xs font-black text-slate-500 uppercase">AI ì‹¬ì¸µ ë¶„ì„</h3>
          <div id="chatStatus" class="text-[9px] font-bold text-indigo-400 opacity-60">ëŒ€í™” ë¶„ì„ ì¤‘</div>
        </div>

        <!-- Chat Container -->
        <div id="chatWindow" class="chat-container flex-grow">
          <div class="chat-bubble ai">ë°˜ê°€ì›Œìš”! ì–´ì œ ì ì€ ì–´ë– ì…¨ë‚˜ìš”? í‰ì†Œë³´ë‹¤ ë¶ˆí¸í–ˆê±°ë‚˜ íŠ¹ë³„í•œ ê¸°ì–µì´ ìˆë‹¤ë©´ ë§ì”€í•´ ì£¼ì„¸ìš”.</div>
        </div>

        <!-- AI Buffering View -->
        <div id="aiLoading" class="ai-loading">
          <div class="spinner"></div>
          <p class="text-[11px] font-black text-indigo-300 animate-pulse uppercase tracking-widest">AIê°€ ë°ì´í„°ë¥¼ ì‹¬ì¸µ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
        </div>

        <!-- Chat Controls -->
        <div id="chatControls" class="flex gap-2 mt-4">
          <input id="chatInputBox" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="flex-1 bg-white/5 border border-white/10 p-4 rounded-2xl outline-none text-sm focus:border-indigo-500">
          <button onclick="handleSendMessage()" class="p-4 bg-indigo-600 rounded-2xl shadow-xl active:scale-90 transition">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
          </button>
        </div>

        <!-- Final Report View -->
        <div id="reportSection" class="hidden">
          <div class="modern-report">
            <span class="report-label">AI SLEEP ANALYSIS</span>
            <div id="reportContent" class="text-[0.95rem] leading-relaxed text-slate-800 font-medium"></div>
            <div class="mt-8 pt-4 border-t border-slate-100 flex justify-between items-center">
              <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Jal-Jam Digital Doctor</span>
              <span class="text-xl">ğŸŒ™</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Guide -->
    <div id="tab-info" class="tab-content p-6">
      <h2 class="text-2xl font-black mb-8">ìˆ˜ë©´ ì§€ì‹</h2>
      <div class="glass-card mb-4">
        <h4 class="text-xs font-black text-indigo-400 mb-6 uppercase tracking-widest">ê¶Œì¥ ìˆ˜ë©´ ê°€ì´ë“œ</h4>
        <div class="space-y-3">
          <div class="flex justify-between items-center p-5 bg-white/5 rounded-3xl border border-white/5 text-xs"><span class="text-slate-400">ì„±ì¸ (18-64ì„¸)</span><span class="font-black text-indigo-300">7 - 9 ì‹œê°„</span></div>
          <div class="flex justify-between items-center p-5 bg-white/5 rounded-3xl border border-white/5 text-xs"><span class="text-slate-400">ì²­ì†Œë…„ (14-17ì„¸)</span><span class="font-black text-indigo-300">8 - 10 ì‹œê°„</span></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Tab: Log Sequential Overlay -->
  <div id="tab-log" class="hidden">
    <div id="logStep1" class="log-step active">
      <h2 class="text-3xl font-black mb-4">ì–´ì œ ë°¤,<br>ëª‡ ì‹œì— ì ë“œì…¨ë‚˜ìš”?</h2>
      <p class="text-slate-500 text-xs mb-10 tracking-wider font-bold">10ë¶„ ë‹¨ìœ„ë¡œ ì •êµí•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”.</p>
      <div class="flex-1 flex flex-col justify-center">
        <input id="logInSleep" type="time" step="600" value="23:00" class="w-full bg-transparent border-b-2 border-indigo-500 py-6 outline-none text-5xl text-center font-black text-indigo-400">
      </div>
      <button onclick="moveLogStep(2)" class="btn-main mt-auto">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
    </div>

    <div id="logStep2" class="log-step">
      <h2 class="text-3xl font-black mb-4">ì˜¤ëŠ˜ ì•„ì¹¨,<br>ì–¸ì œ ì¼ì–´ë‚˜ì…¨ë‚˜ìš”?</h2>
      <p class="text-slate-500 text-xs mb-10 tracking-wider font-bold">ì˜¤ëŠ˜ í•˜ë£¨ë„ í˜ì°¨ê²Œ ì‹œì‘í•´ë´ìš”.</p>
      <div class="flex-1 flex flex-col justify-center">
        <input id="logInWake" type="time" step="600" value="07:00" class="w-full bg-transparent border-b-2 border-emerald-500 py-6 outline-none text-5xl text-center font-black text-emerald-400">
      </div>
      <div class="mt-auto flex gap-4">
        <button onclick="moveLogStep(1)" class="flex-1 bg-white/5 p-5 rounded-3xl font-bold text-slate-400 border border-white/5 text-sm">ì´ì „</button>
        <button onclick="moveLogStep(3)" class="flex-[2] btn-main">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
      </div>
    </div>

    <div id="logStep3" class="log-step">
      <h2 class="text-2xl font-black mb-10 text-center uppercase tracking-tighter">ì˜¤ëŠ˜ ì•„ì¹¨ ì»¨ë””ì…˜</h2>
      <div class="grid grid-cols-5 gap-3 mb-14">
        <button onclick="pickFatigueState(1)" class="fatigue-item" data-v="1"><span class="text-2xl">ğŸ˜µ</span><span class="text-[9px] font-black text-slate-500">ì§€ì¹¨</span></button>
        <button onclick="pickFatigueState(2)" class="fatigue-item" data-v="2"><span class="text-2xl">ğŸ¥±</span><span class="text-[9px] font-black text-slate-500">í”¼ê³¤</span></button>
        <button onclick="pickFatigueState(3)" class="fatigue-item active" data-v="3"><span class="text-2xl">ğŸ˜</span><span class="text-[9px] font-black text-slate-500">ë³´í†µ</span></button>
        <button onclick="pickFatigueState(4)" class="fatigue-item" data-v="4"><span class="text-2xl">ğŸ™‚</span><span class="text-[9px] font-black text-slate-500">ì¾Œì </span></button>
        <button onclick="pickFatigueState(5)" class="fatigue-item" data-v="5"><span class="text-2xl">âœ¨</span><span class="text-[9px] font-black text-slate-500">ìƒì¾Œ</span></button>
      </div>
      <div class="mt-auto flex gap-4">
        <button onclick="moveLogStep(2)" class="flex-1 bg-white/5 p-5 rounded-3xl font-bold text-slate-400 border border-white/5 text-sm">ì´ì „</button>
        <button onclick="moveLogStep(4)" class="flex-[2] btn-main">ë§ˆì§€ë§‰ ë‹¨ê³„</button>
      </div>
    </div>

    <div id="logStep4" class="log-step">
      <h2 class="text-2xl font-black mb-4">í™œë™/ì§€ì—° ì‚¬ìœ </h2>
      <p class="text-slate-500 text-xs mb-10 font-bold uppercase tracking-widest">ì–´ë–¤ ì¼ë“¤ì´ ìˆì—ˆë‚˜ìš”?</p>
      <div id="tagPills" class="flex flex-wrap gap-3 mb-14">
        <button onclick="pickActivityTag(this)" class="px-6 py-3 bg-white/5 border border-white/10 rounded-2xl text-xs font-bold text-slate-400 transition">ìš´ë™</button>
        <button onclick="pickActivityTag(this)" class="px-6 py-3 bg-white/5 border border-white/10 rounded-2xl text-xs font-bold text-slate-400 transition">ë…ì„œ</button>
        <button onclick="pickActivityTag(this)" class="px-6 py-3 bg-white/5 border border-white/10 rounded-2xl text-xs font-bold text-slate-400 transition">ìœ íŠœë¸Œ/SNS</button>
        <button onclick="pickActivityTag(this)" class="px-6 py-3 bg-white/5 border border-white/10 rounded-2xl text-xs font-bold text-slate-400 transition">ì•½ì†/íšŒì‹</button>
        <button onclick="pickActivityTag(this)" class="px-6 py-3 bg-white/5 border border-white/10 rounded-2xl text-xs font-bold text-slate-400 transition">ê³µë¶€/ì•¼ê·¼</button>
      </div>
      <div class="mt-auto flex gap-4">
        <button onclick="moveLogStep(3)" class="flex-1 bg-white/5 p-5 rounded-3xl font-bold text-slate-400 border border-white/5 text-sm">ì´ì „</button>
        <button onclick="executeFinalLog()" class="flex-[2] btn-main shadow-indigo-600/40">ê¸°ë¡ ì™„ë£Œ</button>
      </div>
    </div>
  </div>

  <!-- Navigation Bar -->
  <nav id="bottomNav">
    <div onclick="switchTab('home')" class="nav-item active">
      <span class="text-2xl mb-1">ğŸ </span><span>Home</span>
    </div>
    <div onclick="switchTab('weekly')" class="nav-item">
      <span class="text-2xl mb-1">ğŸ“Š</span><span>Stats</span>
    </div>
    <div onclick="switchTab('info')" class="nav-item">
      <span class="text-2xl mb-1">ğŸ’¡</span><span>Guide</span>
    </div>
  </nav>
</div>

<script>
  const apiKey = "";
  let userData = {
    name: '', age: 0, gender: 'male',
    history: [], chatCnt: 0, isConcluded: false, lastAiReport: "", lastDateLogged: ""
  };

  let scene, camera, renderer, charGroup, skySphere, sunMoon, stars, charLegL, charLegR, charArmL, charArmR;
  let animTime = 0, dayCycle = 0.5, currentTag = "íœ´ì‹", currentFatigue = 3;

  window.onload = () => {
    const today = new Date();
    document.getElementById('homeDateLabel').innerText = today.toLocaleDateString('ko-KR', { year:'numeric', month:'long', day:'numeric' });
    init3DScene();
    animateLoop();

    const savedData = localStorage.getItem('jalJam_v10_final');
    if (savedData) {
      userData = JSON.parse(savedData);
      document.getElementById('onboarding').style.display = 'none';
      document.getElementById('headerName').innerText = userData.name;
      checkDailySession();
      if(userData.isConcluded) showFinalModernReport(userData.lastAiReport);
    }

    document.getElementById('chatInputBox').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSendMessage(); });
    updateUIRefresh();
    dayCycle = (today.getHours() * 3600 + today.getMinutes() * 60) / 86400;
  };

  function selectGender(g) {
    userData.gender = g;
    document.getElementById('gBtn-male').className = 'flex-1 p-4 rounded-2xl font-bold transition ' + (g === 'male' ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-white/5 border border-white/10 text-slate-500');
    document.getElementById('gBtn-female').className = 'flex-1 p-4 rounded-2xl font-bold transition ' + (g === 'female' ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-white/5 border border-white/10 text-slate-500');
  }

  function submitLogin() {
    const name = document.getElementById('userNameIn').value;
    const age = document.getElementById('userAgeIn').value;
    if(!name || !age) return;
    userData.name = name;
    userData.age = parseInt(age);
    document.getElementById('headerName').innerText = userData.name;
    document.getElementById('onboarding').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('onboarding').style.display = 'none';
      checkDailySession();
      applyCharGenderColors();
    }, 600);
    persistData();
  }

  function checkDailySession() {
    const todayKey = new Date().toISOString().split('T')[0];
    if (userData.lastDateLogged !== todayKey) switchTab('log');
  }

  function switchTab(t) {
    const contents = document.querySelectorAll('.tab-content');
    const navItems = document.querySelectorAll('.nav-item');
    const logTab = document.getElementById('tab-log');

    contents.forEach(c => c.classList.remove('active'));
    navItems.forEach(n => n.classList.remove('active'));
    logTab.classList.add('hidden');

    if (t === 'log') {
      logTab.classList.remove('hidden');
      document.body.classList.add('is-recording');
      moveLogStep(1);
    } else {
      document.getElementById(`tab-${t}`).classList.add('active');
      const btn = document.querySelector(`.nav-item[onclick="switchTab('${t}')"]`);
      if(btn) btn.classList.add('active');
      document.body.classList.remove('is-recording');
    }
    if (t === 'home') setTimeout(() => window.dispatchEvent(new Event('resize')), 50);
  }

  function moveLogStep(s) {
    document.querySelectorAll('.log-step').forEach(step => step.classList.remove('active'));
    const target = document.getElementById(`logStep${s}`);
    if (target) target.classList.add('active');
  }

  function pickFatigueState(v) {
    currentFatigue = v;
    document.querySelectorAll('.fatigue-item').forEach(i => {
      i.classList.remove('active');
      i.querySelector('span:last-child').className = "text-[9px] font-black text-slate-500";
    });
    const active = document.querySelector(`.fatigue-item[data-v="${v}"]`);
    active.classList.add('active');
    active.querySelector('span:last-child').className = "text-[9px] font-black text-indigo-300";
  }

  function pickActivityTag(btn) {
    currentTag = btn.innerText;
    document.querySelectorAll('#tagPills button').forEach(t => {
      t.className = "px-6 py-3 bg-white/5 border border-white/10 rounded-2xl text-xs font-bold text-slate-400 transition";
    });
    btn.className = "px-6 py-3 bg-indigo-600 text-white border-indigo-500 rounded-2xl text-xs font-bold transition shadow-lg shadow-indigo-600/20";
  }

  function executeFinalLog() {
    const todayKey = new Date().toISOString().split('T')[0];
    const sleepVal = document.getElementById('logInSleep').value;
    const wakeVal = document.getElementById('logInWake').value;
    const sleepD = new Date(`${todayKey}T${sleepVal}`);
    let wakeD = new Date(`${todayKey}T${wakeVal}`);
    if (wakeD < sleepD) wakeD.setDate(wakeD.getDate() + 1);
    const totalHours = parseFloat(((wakeD - sleepD) / (1000 * 60 * 60)).toFixed(1));

    userData.history = userData.history.filter(h => h.date !== todayKey);
    userData.history.push({ date: todayKey, hours: totalHours, activity: currentTag, fatigue: currentFatigue });
    userData.lastDateLogged = todayKey;
    userData.chatCnt = 0; userData.isConcluded = false; userData.lastAiReport = "";

    persistData();
    updateUIRefresh();
    resetDailyConversation();
    switchTab('home');
  }

  function persistData() { localStorage.setItem('jalJam_v10_final', JSON.stringify(userData)); }

  function updateUIRefresh() {
    const last = userData.history[userData.history.length - 1];
    document.getElementById('hHoursDisplay').innerText = last ? `${last.hours}H` : '0.0H';
    const emojiMap = ["", "ğŸ˜µ", "ğŸ¥±", "ğŸ˜", "ğŸ™‚", "âœ¨"];
    document.getElementById('hEmojiDisplay').innerText = last ? emojiMap[last.fatigue] : "--";
    document.getElementById('hTagDisplay').innerText = last ? `#${last.activity}` : '#ê¸°ë¡ ëŒ€ê¸°ì¤‘';
    renderWeeklyChart();
  }

  function renderWeeklyChart() {
    const chartArea = document.getElementById('weeklyChartArea');
    chartArea.innerHTML = '';
    const now = new Date(), sun = new Date(now);
    sun.setDate(now.getDate() - now.getDay());
    const dates = [];
    for(let i=0; i<7; i++) {
      const d = new Date(sun); d.setDate(sun.getDate() + i);
      dates.push(d.toISOString().split('T')[0]);
    }
    document.getElementById('weekRange').innerText = `${sun.getMonth()+1}/${sun.getDate()} - ${new Date(dates[6]).getDate()}`;
    dates.forEach(dKey => {
      const entry = userData.history.find(x => x.date === dKey);
      const barWrap = document.createElement('div');
      barWrap.className = 'flex flex-col h-full justify-end';
      if (entry && entry.hours > 0) {
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        // 12H max base for visual height
        bar.style.height = `${Math.min(100, (entry.hours / 12) * 100)}%`;
        bar.innerHTML = `<span class="chart-bar-val">${entry.hours}H</span>`;
        barWrap.appendChild(bar);
      } else {
        const empty = document.createElement('div');
        empty.className = 'chart-bar-empty';
        barWrap.appendChild(empty);
      }
      chartArea.appendChild(barWrap);
    });
  }

  // --- Three.js ---
  function init3DScene() {
    const container = document.getElementById('main-3d-container');
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    skySphere = new THREE.Mesh(new THREE.SphereGeometry(30, 32, 32), new THREE.MeshBasicMaterial({ color: 0x0c4a6e, side: THREE.BackSide }));
    scene.add(skySphere);
    sunMoon = new THREE.Mesh(new THREE.SphereGeometry(1.2, 16, 16), new THREE.MeshBasicMaterial({ color: 0xfde047 }));
    scene.add(sunMoon);

    const starGeo = new THREE.BufferGeometry();
    const starPos = [];
    for(let i=0; i<400; i++) starPos.push(THREE.MathUtils.randFloatSpread(60), THREE.MathUtils.randFloatSpread(60), THREE.MathUtils.randFloatSpread(60));
    starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
    stars = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.15, transparent: true }));
    scene.add(stars);

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const spot = new THREE.PointLight(0xffffff, 1);
    spot.position.set(5, 5, 5); scene.add(spot);

    const floor = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), new THREE.MeshPhongMaterial({ color: 0x111827 }));
    floor.rotation.x = -Math.PI/2; scene.add(floor);
    const wall = new THREE.Mesh(new THREE.BoxGeometry(0.2, 6, 10), new THREE.MeshPhongMaterial({ color: 0x1e293b }));
    wall.position.set(-5, 3, 0); scene.add(wall);

    // Room Objects
    const bed = new THREE.Group();
    bed.add(new THREE.Mesh(new THREE.BoxGeometry(3.2, 0.4, 5.2), new THREE.MeshPhongMaterial({ color: 0x374151 })));
    const mattress = new THREE.Mesh(new THREE.BoxGeometry(3, 0.3, 5), new THREE.MeshPhongMaterial({ color: 0xffffff }));
    mattress.position.y = 0.35; bed.add(mattress);
    const cover = new THREE.Mesh(new THREE.BoxGeometry(3.05, 0.15, 3.5), new THREE.MeshPhongMaterial({ color: 0x4f46e5 }));
    cover.position.set(0, 0.45, -0.7); bed.add(cover);
    bed.position.set(-3, 0.2, -1); scene.add(bed);

    const lampHead = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), new THREE.MeshPhongMaterial({ color: 0xfde047, emissive: 0xfde047, emissiveIntensity: 0.5 }));
    lampHead.position.set(-4.2, 1.2, 1.5); scene.add(lampHead);

    charGroup = new THREE.Group(); charGroup.scale.set(0.65, 0.65, 0.65);
    const skin = new THREE.MeshPhongMaterial({ color: 0xffdbac }), pjs = new THREE.MeshPhongMaterial({ color: 0x818cf8 });
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.7, 0.3), pjs);
    body.name = 'charBody'; body.position.y = 0.85; charGroup.add(body);
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.35), skin); head.position.y = 1.4;
    const eye = new THREE.Mesh(new THREE.SphereGeometry(0.04, 8, 8), new THREE.MeshBasicMaterial({ color: 0x111111 }));
    const eL = eye.clone(); eL.position.set(-0.1, 0.05, 0.18); const eR = eye.clone(); eR.position.x = 0.1;
    const m = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.02, 0.02), new THREE.MeshBasicMaterial({ color: 0xaa4444 }));
    m.position.set(0, -0.1, 0.18); head.add(eL, eR, m); charGroup.add(head);
    const limb = new THREE.BoxGeometry(0.15, 0.5, 0.15);
    charArmL = new THREE.Mesh(limb, skin); charArmL.position.set(-0.35, 1.0, 0);
    charArmR = new THREE.Mesh(limb, skin); charArmR.position.set(0.35, 1.0, 0);
    charLegL = new THREE.Mesh(limb, pjs); charLegL.position.set(-0.15, 0.25, 0); charLegL.name = "charLegL";
    charLegR = new THREE.Mesh(limb, pjs); charLegR.position.set(0.15, 0.25, 0); charLegR.name = "charLegR";
    charGroup.add(charArmL, charArmR, charLegL, charLegR); scene.add(charGroup);
    camera.position.set(4, 3.5, 8.5); camera.lookAt(0, 1.2, 0);
    applyCharGenderColors();
  }

  function applyCharGenderColors() {
    if(!charGroup) return;
    const col = userData.gender === 'male' ? 0x818cf8 : 0xf472b6;
    charGroup.getObjectByName('charBody').material.color.setHex(col);
    charGroup.getObjectByName('charLegL').material.color.setHex(col);
    charGroup.getObjectByName('charLegR').material.color.setHex(col);
  }

  function animateLoop() {
    requestAnimationFrame(animateLoop); animTime += 0.05;
    dayCycle = (dayCycle + 0.00015) % 1;
    const ang = dayCycle * Math.PI * 2;
    sunMoon.position.set(Math.cos(ang)*22, Math.sin(ang)*22, -18);
    const isDayTime = Math.sin(ang) > 0;
    skySphere.material.color.setHex(isDayTime ? 0x38bdf8 : 0x020617);
    sunMoon.material.color.setHex(isDayTime ? 0xfde047 : 0xf8fafc);
    stars.visible = !isDayTime;
    const env = document.getElementById('envLabel');
    if(env) env.innerText = isDayTime ? "í™œê¸°ì°¨ê³  ë°ì€ ë‚®ì…ë‹ˆë‹¤." : "ì¡°ìš©í•˜ê³  ì•„ëŠ‘í•œ ë°¤ì…ë‹ˆë‹¤.";

    if(charGroup) {
      const entry = userData.history[userData.history.length-1];
      if(entry?.activity === 'ìš´ë™') {
        const sq = Math.abs(Math.sin(animTime*2.5))*0.4;
        charGroup.position.y = sq*-0.5+0.05; charArmL.rotation.x = -1; charArmR.rotation.x = -1;
      } else {
        const wk = Math.sin(animTime*3);
        charLegL.rotation.x = wk*0.5; charLegR.rotation.x = -wk*0.5;
        charArmL.rotation.x = -wk*0.4; charArmR.rotation.x = wk*0.4;
        charGroup.position.y = Math.sin(animTime*0.4)*0.03;
      }
    }
    if(renderer) renderer.render(scene, camera);
  }

  // --- AI Analysis Logic ---
  async function handleSendMessage() {
    const input = document.getElementById('chatInputBox');
    if(!input.value || userData.isConcluded) return;
    const msg = input.value;
    addBubble(msg, 'user');
    input.value = ''; userData.chatCnt++;

    const lastLog = userData.history[userData.history.length-1];

    // Fixed understanding of "Yes" intent
    const positiveIntents = ["ì‘", "ê·¸ë˜", "ë„¤", "ë§Œë“¤ì–´ì¤˜", "ê²°ê³¼", "ë¶„ì„", "ì¢‹ì•„", "yes", "okay", "ê·¸ë ‡ê²Œ í•´ì¤˜"];
    const isRequestingReport = positiveIntents.some(keyword => msg.toLowerCase().includes(keyword));

    if (isRequestingReport && userData.chatCnt >= 2) {
      triggerFinalReportGeneration();
      return;
    }

    let prompt = userData.chatCnt >= 3 ?
            `ì‚¬ìš©ì ${userData.name}ì™€ ëŒ€í™” ì¤‘ì…ë‹ˆë‹¤. ëŒ€í™”ê°€ ì¶©ë¶„í•œ ê²ƒ ê°™ìœ¼ë‹ˆ "ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ë§Œë“¤ì–´ ë“œë¦´ê¹Œìš”?"ë¼ê³  ë¬»ê³  ì§ˆë¬¸ì„ ë§ˆì³ì¤˜. í•œêµ­ì–´ë¡œ ë§í•´ì¤˜.` :
            `ì‚¬ìš©ì ${userData.name}ê°€ ì–´ì œ ${lastLog?.hours}H ì¤ê³  í™œë™ì€ ${lastLog?.activity}ì…ë‹ˆë‹¤. ì‚¬ìš©ì: "${msg}". ì¹œì ˆí•˜ê²Œ ê³µê°í•˜ê³  ì§§ì€ ì§ˆë¬¸ì„ í•˜ë‚˜ ë” í•´ì¤˜.`;

    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await res.json();
      addBubble(data.candidates[0].content.parts[0].text, 'ai');
    } catch (e) { addBubble("ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.", 'ai'); }
    persistData();
  }

  async function triggerFinalReportGeneration() {
    document.getElementById('chatControls').classList.add('hidden');
    document.getElementById('chatWindow').classList.add('hidden');
    document.getElementById('aiLoading').classList.add('active');

    const lastLog = userData.history[userData.history.length - 1];
    // Explicit instruction for fatigue mapping: 1 is tired, 5 is fresh
    const prompt = `ìˆ˜ë©´ ë°ì´í„° ì‹¬ì¸µ ë¶„ì„: ì‚¬ìš©ì ${userData.name}(${userData.age}ì„¸). ìˆ˜ë©´ ì‹œê°„(${lastLog?.hours}H), í™œë™(${lastLog?.activity}), ì»¨ë””ì…˜ ì ìˆ˜(${lastLog?.fatigue}ì /5ì  ë§Œì  - 1ì ì´ ê°€ì¥ í”¼ê³¤í•¨, 5ì ì´ ê°€ì¥ ìƒì¾Œí•¨). ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìˆ˜ë©´ ì§ˆì„ ë¶„ì„í•˜ê³  ë‚´ì¼ì„ ìœ„í•œ ì¡°ì–¸ì„ 3~4ë¬¸ì¥ìœ¼ë¡œ ë”°ëœ»í•˜ê³  ê³¼í•™ì ìœ¼ë¡œ ì‘ì„±í•´ì¤˜.`;

    try {
      await new Promise(r => setTimeout(r, 2500)); // Simulating AI thinking

      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await res.json();
      const result = data.candidates[0].content.parts[0].text;

      userData.isConcluded = true;
      userData.lastAiReport = result;
      showFinalModernReport(result);
    } catch (e) {
      showFinalModernReport("ë°ì´í„° ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
      document.getElementById('aiLoading').classList.remove('active');
      persistData();
    }
  }

  function showFinalModernReport(text) {
    document.getElementById('chatWindow').classList.add('hidden');
    document.getElementById('chatControls').classList.add('hidden');
    document.getElementById('reportSection').classList.remove('hidden');
    document.getElementById('reportContent').innerText = text;
    document.getElementById('chatStatus').innerText = "ë¶„ì„ ì™„ë£Œ";
  }

  function resetDailyConversation() {
    document.getElementById('chatWindow').innerHTML = `<div class="chat-bubble ai">ê¸°ë¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì–´ì œ ë°¤ì€ ì¢€ ì–´ë– ì…¨ë‚˜ìš”?</div>`;
    document.getElementById('chatWindow').classList.remove('hidden');
    document.getElementById('chatControls').classList.remove('hidden');
    document.getElementById('reportSection').classList.add('hidden');
    document.getElementById('chatStatus').innerText = "ëŒ€í™” ë¶„ì„ ì¤‘";
  }

  function addBubble(text, sender) {
    const win = document.getElementById('chatWindow');
    const b = document.createElement('div');
    b.className = `chat-bubble ${sender}`; b.innerText = text;
    win.appendChild(b); win.scrollTop = win.scrollHeight;
  }

  window.addEventListener('resize', () => {
    const container = document.getElementById('main-3d-container');
    if(container && renderer && camera) {
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    }
  });
</script>
</body>
</html>
