<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©ì¹˜í˜• RPG: ì±•í„° ë§ˆìŠ¤í„° ë ˆì „ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #020617;
            color: white;
            overflow-x: hidden;
            overflow-y: auto;
            user-select: none;
        }

        .progress-bar { transition: width 0.3s ease-in-out; }

        /* ìºë¦­í„° ë° ëª¬ìŠ¤í„° ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes idleBob {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-6px) scale(1.02); }
        }
        .animate-idle { animation: idleBob 2.5s ease-in-out infinite; }

        /* ëª¬ìŠ¤í„° ë“±ì¥ */
        @keyframes slideIn {
            0% { opacity: 0; transform: translateX(100px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        .monster-enter { animation: slideIn 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards; }

        /* ì±•í„°ë³„ ë°°ê²½ í…Œë§ˆ */
        .bg-meadow {
            background-image: url('image_6dded7.jpg');
            background-size: cover;
            background-position: center;
        }
        .bg-ocean { background: linear-gradient(180deg, #0ea5e9 0%, #1e40af 100%); }
        .bg-volcano { background: linear-gradient(180deg, #f43f5e 0%, #881337 100%); }
        .bg-wasteland { background: linear-gradient(180deg, #fbbf24 0%, #92400e 100%); }
        .bg-castle { background: linear-gradient(180deg, #a855f7 0%, #4c1d95 100%); }

        #battle-bg {
            aspect-ratio: 1 / 1;
            width: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 2.5rem;
        }

        .hud-glass {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        /* ìŠ¤í‚¬ ìŠ¬ë¡¯ ê°€ì‹œì„± ê°•í™” */
        .skill-slot {
            width: 4rem; height: 4rem; border-radius: 1.2rem;
            background: rgba(15, 23, 42, 0.9); border: 2px solid rgba(255,255,255,0.1);
            position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        .skill-ready { border-color: #818cf8; box-shadow: 0 0 15px rgba(129,140,248,0.6); }
        .skill-level-badge {
            position: absolute; top: -1px; right: -1px;
            background: #4338ca; color: white;
            font-size: 10px; font-weight: 900; padding: 2px 8px;
            border-radius: 0 1.2rem 0 1rem; border: 1.5px solid rgba(255,255,255,0.3);
            z-index: 30;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.3);
        }

        /* ì´í™íŠ¸ */
        .effect-node { position: absolute; pointer-events: none; z-index: 100; }
        .slash-active {
            animation: slashAnim 0.3s steps(4) forwards;
            background: white; height: 5px; width: 140px; transform: rotate(-45deg);
        }
        @keyframes slashAnim {
            0% { opacity: 0; transform: translate(-30px, -30px) rotate(-45deg) scaleX(0.1); }
            50% { opacity: 1; transform: translate(0, 0) rotate(-45deg) scaleX(1.2); }
            100% { opacity: 0; transform: translate(30px, 30px) rotate(-45deg) scaleX(1.6); }
        }
        .burst-active {
            animation: burstAnim 0.4s steps(5) forwards;
            background: radial-gradient(circle, #fff 0%, #818cf8 60%, transparent 80%);
            width: 140px; height: 140px; border-radius: 50%;
        }
        @keyframes burstAnim {
            0% { opacity: 0; transform: scale(0.2); }
            100% { opacity: 0; transform: scale(2.5); }
        }

        .damage-float {
            animation: floatUp 0.8s steps(6) forwards;
            position: absolute; font-weight: 900; pointer-events: none; z-index: 150;
            text-shadow: 2px 2px 0px #000;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-80px); }
        }

        #job-overlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
        }
        .pixelated { image-rendering: pixelated; }
    </style>
</head>
<body class="flex flex-col items-center">

<!-- ì‹œì‘ ì§ì—… ì„ íƒ ëª¨ë‹¬ -->
<div id="job-overlay">
    <div class="bg-slate-900 p-8 rounded-[2.5rem] border-4 border-indigo-500/20 max-w-sm w-full text-center space-y-6 shadow-2xl">
        <h1 class="text-2xl font-black text-indigo-400 tracking-tighter uppercase italic tracking-[0.2em]">ì „ì„¤ì˜ ëª¨í—˜ê°€ ì„ íƒ</h1>
        <div class="grid gap-3">
            <button onclick="selectJob('warrior')" class="flex items-center justify-between bg-slate-800/50 p-4 rounded-2xl border border-slate-700 hover:border-orange-500 transition group shadow-lg">
                <div class="bg-slate-950 p-1 rounded-lg" id="preview-warrior"></div>
                <div class="text-right">
                    <div class="font-black text-lg text-orange-400 uppercase">Warrior</div>
                    <div class="text-[8px] text-slate-500 font-bold uppercase tracking-widest">ê°•ì² ì˜ ë„íŠ¸ ì „ì‚¬</div>
                </div>
            </button>
            <button onclick="selectJob('mage')" class="flex items-center justify-between bg-slate-800/50 p-4 rounded-2xl border border-slate-700 hover:border-purple-500 transition group shadow-lg">
                <div class="bg-slate-950 p-1 rounded-lg" id="preview-mage"></div>
                <div class="text-right">
                    <div class="font-black text-lg text-purple-400 uppercase">Mage</div>
                    <div class="text-[8px] text-slate-500 font-bold uppercase tracking-widest">ë¹„ì „ ëŒ€ë§ˆë²•ì‚¬</div>
                </div>
            </button>
            <button onclick="selectJob('thief')" class="flex items-center justify-between bg-slate-800/50 p-4 rounded-2xl border border-slate-700 hover:border-emerald-500 transition group shadow-lg">
                <div class="bg-slate-950 p-1 rounded-lg" id="preview-thief"></div>
                <div class="text-right">
                    <div class="font-black text-lg text-emerald-400 uppercase">Thief</div>
                    <div class="text-[8px] text-slate-500 font-bold uppercase tracking-widest">ê·¸ë¦¼ì ì•”ì‚´ì</div>
                </div>
            </button>
        </div>
    </div>
</div>

<div id="app" class="w-full max-w-md min-h-screen flex flex-col p-4 space-y-3">

    <!-- ìµœìƒë‹¨ ë¦¬ì†ŒìŠ¤ ë°” -->
    <div class="flex justify-between items-center px-2 shrink-0">
        <div class="bg-slate-900/80 px-4 py-1.5 rounded-full border border-slate-800 shadow-lg">
            <span class="text-emerald-400 font-black text-sm" id="p-gold">0 G</span>
        </div>
        <div class="bg-slate-900/80 px-4 py-1.5 rounded-full border border-slate-800 shadow-lg">
            <span class="text-red-400 font-black text-[10px] italic">POTION <span id="p-potions">0</span></span>
        </div>
    </div>

    <!-- ì •ì‚¬ê°í˜• ì „íˆ¬ êµ¬ì—­ -->
    <div id="battle-bg" class="bg-meadow shadow-2xl flex flex-col border-4 border-slate-800/50 transition-all duration-1000 relative overflow-hidden">

        <!-- ë¯¸ë‹ˆ ì±•í„° HUD (ìµœìƒë‹¨) -->
        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 flex flex-col items-center pointer-events-none">
            <div class="hud-glass px-3 py-1 rounded-full text-[8px] font-black tracking-[0.4em] text-white shadow-2xl mb-1 border border-white/20 uppercase" id="chapter-display">CH 1-1</div>
            <div class="w-16 bg-black/50 h-1 rounded-full overflow-hidden">
                <div id="stage-progress-bar" class="bg-white h-full progress-bar shadow-[0_0_8px_white]" style="width: 0%"></div>
            </div>
        </div>

        <!-- ì‹¤ì œ ì „íˆ¬ ì˜ì—­ -->
        <div class="flex-grow w-full flex items-center justify-between px-10 relative">
            <!-- ì£¼ì¸ê³µ ìºë¦­í„° -->
            <div class="relative animate-idle" id="player-node">
                <div class="w-14 h-2 bg-black/40 absolute -bottom-2 left-1/2 -translate-x-1/2 rounded-[50%] blur-md"></div>
                <div id="player-sprite-container"></div>
                <div id="player-damage-container" class="absolute -top-16 left-1/2 -translate-x-1/2 w-32 h-32 pointer-events-none"></div>

                <!-- ìºë¦­í„° HPë°” -->
                <div class="absolute -bottom-12 left-1/2 -translate-x-1/2 w-14">
                    <div class="w-full bg-black/60 h-1 rounded-full overflow-hidden border border-white/10 shadow-lg">
                        <div id="p-hp-bar-small" class="bg-red-500 h-full progress-bar" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div class="text-white/5 font-black italic text-4xl select-none uppercase tracking-tighter pointer-events-none z-0">FIGHT</div>

            <!-- ëª¬ìŠ¤í„° ì˜ì—­ -->
            <div class="relative" id="enemy-node">
                <div id="enemy-area" class="opacity-0 flex flex-col items-center">
                    <div class="w-16 h-3 bg-black/40 absolute -bottom-3 left-1/2 -translate-x-1/2 rounded-[50%] blur-md"></div>
                    <!-- ì§€ì •í•´ì£¼ì‹  ì´ëª¨ì§€ ë¦¬ìŠ¤íŠ¸ ì‚¬ìš© -->
                    <div id="enemy-sprite" class="text-7xl drop-shadow-2xl mb-2">ğŸ‘¾</div>

                    <div class="absolute -top-14 left-1/2 -translate-x-1/2 w-20">
                        <div class="w-full bg-black/60 h-1.5 rounded-full overflow-hidden shadow-lg">
                            <div id="e-hp-bar" class="bg-orange-500 h-full progress-bar" style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- ëª¬ìŠ¤í„° ë¯¸ë‹ˆ ì •ë³´ì°½ -->
                    <div class="mt-4 hud-glass px-2 py-1 rounded-lg text-[6px] font-black min-w-[75px] border border-white/5 text-center">
                        <span id="enemy-name" class="block mb-1 text-white/80 tracking-tighter truncate font-bold uppercase">MONSTER</span>
                        <div class="grid grid-cols-2 gap-1 text-[5px]">
                            <span class="text-orange-400">A:<span id="e-stat-atk">0</span></span>
                            <span class="text-blue-400">D:<span id="e-stat-def">0</span></span>
                        </div>
                    </div>
                </div>
                <div id="enemy-damage-container" class="absolute -top-16 left-1/2 -translate-x-1/2 w-32 h-32 pointer-events-none"></div>
                <div id="slash-effect" class="effect-node top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
                <div id="burst-effect" class="effect-node top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
            </div>
        </div>

        <!-- [HUD í†µí•© ë°°ì¹˜] ìŠ¤í‚¬ + ë ˆë²¨ + ê²½í—˜ì¹˜ -->
        <div class="z-20 w-full px-6 pb-6 flex flex-col items-center space-y-4">
            <!-- ìŠ¤í‚¬ ìŠ¬ë¡¯ ì˜ì—­ (í™•ëŒ€) -->
            <div id="skill-container" class="flex space-x-4 justify-center"></div>

            <!-- í†µí•© ì„±ì¥ HUD -->
            <div class="hud-glass w-full max-w-[280px] px-5 py-3 rounded-[1.5rem] flex items-center space-x-5 shadow-2xl">
                <div class="flex flex-col shrink-0">
                    <div class="text-[8px] text-indigo-400 font-black uppercase leading-none mb-1 tracking-widest" id="p-job-display">READY</div>
                    <div class="text-white font-black text-2xl tracking-tighter leading-none">Lv.<span id="p-level">1</span></div>
                </div>
                <div class="flex-grow flex flex-col justify-center">
                    <div class="flex justify-between text-[7px] font-black text-white/40 uppercase mb-1 tracking-tighter">
                        <span>Experience Progress</span>
                        <span id="exp-text">0 / 10</span>
                    </div>
                    <div class="w-full bg-black/50 h-2 rounded-full overflow-hidden p-[1.5px] border border-white/5">
                        <div id="exp-progress-bar" class="bg-gradient-to-r from-indigo-500 to-blue-400 h-full progress-bar rounded-full shadow-[0_0_8px_rgba(99,102,241,0.6)]" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ë‰´ êµ¬ì—­ -->
    <div class="shrink-0 space-y-3">
        <!-- 4ëŒ€ ìŠ¤íƒ¯ í•œëˆˆì— ë³´ê¸° -->
        <div class="grid grid-cols-4 gap-2 bg-slate-900/80 p-3 rounded-[1.5rem] border border-slate-800 shadow-xl">
            <div class="text-center"><div class="text-[6px] text-slate-500 uppercase font-black mb-0.5">P-Atk</div><div id="p-atk" class="text-[10px] text-orange-400 font-black">0</div></div>
            <div class="text-center"><div class="text-[6px] text-slate-500 uppercase font-black mb-0.5">P-Def</div><div id="p-def" class="text-[10px] text-blue-400 font-black">0</div></div>
            <div class="text-center"><div class="text-[6px] text-slate-500 uppercase font-black mb-0.5">M-Atk</div><div id="p-mag-atk" class="text-[10px] text-purple-400 font-black">0</div></div>
            <div class="text-center"><div class="text-[6px] text-slate-500 uppercase font-black mb-0.5">M-Def</div><div id="p-mag-def" class="text-[10px] text-cyan-400 font-black">0</div></div>
        </div>

        <div class="grid grid-cols-3 gap-2">
            <button onclick="switchTab('combat')" id="btn-combat" class="bg-indigo-600 py-3 rounded-2xl font-black shadow-lg transition active:scale-95 text-[10px] uppercase text-white">ì „íˆ¬</button>
            <button onclick="switchTab('upgrade')" id="btn-upgrade" class="bg-slate-800 py-3 rounded-2xl font-black shadow-lg transition text-indigo-300 active:scale-95 text-[10px] uppercase">ê°•í™”</button>
            <button onclick="switchTab('shop')" id="btn-shop" class="bg-slate-800 py-3 rounded-2xl font-black shadow-lg transition text-indigo-300 active:scale-95 text-[10px] uppercase">ìƒì </button>
        </div>
    </div>

    <!-- í•˜ë‹¨ ìƒì„¸ ì •ë³´ íŒ¨ë„ -->
    <div class="grow flex flex-col bg-slate-900 rounded-[2.5rem] border border-slate-800 overflow-hidden min-h-[140px] shadow-inner">
        <div id="panel-combat" class="flex flex-col h-full p-5">
            <div class="flex justify-between items-center mb-2 border-b border-slate-800 pb-2">
                <span class="text-[9px] text-indigo-400 font-black tracking-widest uppercase">ì‹¤ì‹œê°„ ëª¨í—˜ ê¸°ë¡</span>
                <button onclick="toggleSpeed()" id="speed-btn" class="text-[7px] font-bold bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-full border border-indigo-500/20 uppercase">SPEED x1</button>
            </div>
            <div id="battle-log" class="log-container grow overflow-y-auto text-[9px] space-y-1.5 text-slate-400 pr-1">
                <div>ëª¨í—˜ê°€ë‹˜, ì‹œì‘í•  ìºë¦­í„°ë¥¼ ê³ ë¥´ì„¸ìš”!</div>
            </div>
        </div>

        <div id="panel-upgrade" class="hidden h-full p-5 overflow-y-auto space-y-2">
            <h3 class="font-black text-indigo-400 text-[10px] uppercase mb-1 tracking-widest">ìˆ˜ë ¨ ì„¼í„°</h3>
            <div id="upgrade-list" class="space-y-2"></div>
        </div>

        <div id="panel-shop" class="hidden h-full p-5 overflow-y-auto space-y-3">
            <h3 class="font-black text-yellow-400 text-[10px] uppercase mb-1 tracking-widest">ë¹„ë°€ ê±°ë˜ì†Œ</h3>
            <div class="flex justify-between items-center bg-green-900/10 p-3 rounded-2xl border border-green-500/20 mb-1">
                <div class="flex flex-col">
                    <span class="text-[10px] font-black text-green-400">ìƒëª…ì˜ ì •ìˆ˜ (x5)</span>
                    <span class="text-[7px] text-slate-500 font-bold uppercase">ì²´ë ¥ 30% ë¯¸ë§Œ ì‹œ ìë™ ì‚¬ìš©</span>
                </div>
                <button onclick="buyPotion()" class="bg-green-700 hover:bg-green-600 px-4 py-1.5 rounded-xl text-[10px] font-black shadow-lg text-white">10 G</button>
            </div>
            <div id="shop-items" class="space-y-2 pb-4"></div>
        </div>
    </div>
</div>

<script>
    // ---------------------------------------------------------
    // ìºë¦­í„° SVG ìƒì„±ê¸° (ì „ì‚¬: ì—…ë¡œë“œ ì´ë¯¸ì§€ íŠ¹ì§•, ë‚˜ë¨¸ì§€ëŠ” ë³µêµ¬)
    // ---------------------------------------------------------
    const getHeroSVG = (job, width = 80) => {
        const colors = {
            warrior: { armor: '#94a3b8', cloth: '#b91c1c', plume: '#ef4444', sword: '#f8fafc', shield: '#64748b' },
            mage: { body: '#7e22ce', cloth: '#4c1d95', weapon: '#e9d5ff', acc: '#f0abfc' },
            thief: { body: '#059669', cloth: '#064e3b', weapon: '#94a3b8', acc: '#34d399' }
        };
        const c = colors[job];
        const p = 4;

        if(job === 'warrior') {
            return `<svg viewBox="0 0 80 100" class="pixelated" style="width: ${width}px; height: auto;">
                <defs><filter id="sh"><feGaussianBlur in="SourceAlpha" stdDeviation="1.2" /><feOffset dx="2" dy="2" /><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
                <rect x="32" y="80" width="${p*2}" height="${p*3}" fill="#1e293b" />
                <rect x="44" y="80" width="${p*2}" height="${p*3}" fill="#1e293b" />
                <rect x="28" y="48" width="${p*8}" height="${p*8}" fill="${c.armor}" stroke="black" stroke-width="0.5" filter="url(#sh)"/>
                <rect x="24" y="44" width="${p*10}" height="${p*2}" fill="${c.cloth}" />
                <rect x="26" y="0" width="${p*4}" height="${p*2}" fill="${c.plume}" />
                <rect x="30" y="12" width="${p*9}" height="${p*8}" fill="${c.armor}" stroke="black" stroke-width="0.5" filter="url(#sh)"/>
                <rect x="36" y="16" width="${p*6}" height="${p}" fill="#1e293b" />
                <path d="M 45 55 L 65 55 L 65 75 Q 55 85 45 75 Z" fill="${c.shield}" stroke="black" stroke-width="0.5" />
                <rect x="15" y="40" width="${p*2}" height="${p*11}" fill="${c.sword}" stroke="black" stroke-width="0.5" transform="rotate(-10, 20, 50)"/>
                <rect x="12" y="82" width="${p*3}" height="${p}" fill="#451a03" stroke="black" stroke-width="0.5" transform="rotate(-10, 20, 50)"/>
            </svg>`;
        } else if(job === 'mage') {
            return `<svg viewBox="0 0 80 100" style="width: ${width}px; height: auto;">
                <rect x="20" y="75" width="40" height="15" rx="5" fill="#1e293b" />
                <rect x="22" y="45" width="36" height="35" rx="12" fill="${c.body}" stroke="black" stroke-width="1"/>
                <circle cx="40" cy="30" r="26" fill="#ffedd5" stroke="black" stroke-width="1"/>
                <path d="M 15 25 L 40 5 L 65 25 Z" fill="${c.cloth}" stroke="black" stroke-width="1"/>
                <rect x="60" y="20" width="4" height="60" fill="#451a03" rx="2"/>
                <circle cx="62" cy="15" r="8" fill="${c.acc}" fill-opacity="0.8"/>
                <circle cx="34" cy="32" r="3" fill="#0f172a" /><circle cx="46" cy="32" r="3" fill="#0f172a" />
            </svg>`;
        } else { // thief
            return `<svg viewBox="0 0 80 100" style="width: ${width}px; height: auto;">
                <rect x="20" y="75" width="40" height="15" rx="5" fill="#1e293b" />
                <rect x="22" y="45" width="36" height="35" rx="10" fill="${c.body}" stroke="black" stroke-width="1"/>
                <circle cx="40" cy="30" r="26" fill="#ffedd5" stroke="black" stroke-width="1"/>
                <rect x="22" y="10" width="36" height="20" rx="10" fill="${c.cloth}" stroke="black" stroke-width="1"/>
                <rect x="10" y="55" width="8" height="25" fill="${c.weapon}" stroke="black" stroke-width="0.5" />
                <rect x="62" y="55" width="8" height="25" fill="${c.weapon}" stroke="black" stroke-width="0.5" />
                <circle cx="34" cy="32" r="3" fill="#0f172a" /><circle cx="46" cy="32" r="3" fill="#0f172a" />
            </svg>`;
        }
    };

    // ---------------------------------------------------------
    // ê²Œì„ ì‹œìŠ¤í…œ ë°ì´í„°
    // ---------------------------------------------------------
    const state = {
        isInitialized: false, gameSpeed: 1,
        player: {
            job: null, jobName: '', level: 1, exp: 0, gold: 0,
            baseAtk: 0, baseDef: 0, baseMagAtk: 0, baseMagDef: 0,
            maxHp: 5000, hp: 5000, potions: 0,
            upgrades: { atk: 0, def: 0, magAtk: 0, magDef: 0 },
            equipment: { weapon: null, armor: null }
        },
        world: { chapter: 1, subStage: 1, totalKills: 0, subStageKills: 0, maxChapters: 5 },
        currentEnemy: null,
        shopItems: [
            { id: 'w1', name: 'ì´ˆë³´ì˜ ë„ë¼', type: 'weapon', atk: 350, magAtk: 50, price: 30 },
            { id: 'w2', name: 'ì°¸ê²©ì˜ ëŒ€ê²€', type: 'weapon', atk: 2000, magAtk: 300, price: 500 },
            { id: 'w3', name: 'ì‹ ì˜ ì‹¬íŒ', type: 'weapon', atk: 15000, magAtk: 3000, price: 3000 },
            { id: 'm1', name: 'ê³ ëŒ€ ì§€íŒ¡ì´', type: 'weapon', atk: 50, magAtk: 650, price: 30 },
            { id: 'm2', name: 'ë³„ì˜ ë³´ì£¼', type: 'weapon', atk: 180, magAtk: 4000, price: 500 },
            { id: 'm3', name: 'ì°¨ì› íŒŒì‡„ê¸°', type: 'weapon', atk: 600, magAtk: 22000, price: 3000 },
            { id: 'a1', n: 'ê°€ì£½ ë¹„ëŠ˜ ì˜·', type: 'armor', def: 250, magDef: 220, price: 30 },
            { id: 'a2', n: 'ìš©ê¸ˆ ì „ì‹ ê°‘ì£¼', type: 'armor', def: 1800, magDef: 1600, price: 600 },
            { id: 'a3', n: 'ì„±ì—­ì˜ ë³´ì„', type: 'armor', def: 10000, magDef: 9500, price: 4500 }
        ],
        boughtIds: []
    };

    const chapterBases = {
        1: { hp: 350, atk: 55, def: 35, magAtk: 30, magDef: 35, gold: 120, theme: 'bg-meadow' },
        2: { hp: 2200, atk: 260, def: 200, magAtk: 180, magDef: 200, gold: 500, theme: 'bg-ocean' },
        3: { hp: 10000, atk: 900, def: 800, magAtk: 700, magDef: 800, gold: 2000, theme: 'bg-volcano' },
        4: { hp: 55000, atk: 3500, def: 3000, magAtk: 2500, magDef: 3000, gold: 8000, theme: 'bg-wasteland' },
        5: { hp: 280000, atk: 12000, def: 11000, magAtk: 9000, magDef: 11000, gold: 45000, theme: 'bg-castle' }
    };

    const jobSkills = {
        warrior: [
            { id: 'w1', name: "ë°©ì–´êµ¬ íŒŒì‡„", unlock: 2, mult: 7.5, ignoreDef: 0.5, cd: 4000, lastUsed: 0, type: 'atk', icon: 'âš”ï¸' },
            { id: 'w2', name: "ë°©íŒ¨ ëŒê²©", unlock: 5, mult: 12.0, ignoreDef: 0.7, cd: 7500, lastUsed: 0, type: 'atk', icon: 'ğŸ›¡ï¸' },
            { id: 'w3', name: "ìš©ì‹ ì˜ ì°¸ê²©", unlock: 8, mult: 45.0, ignoreDef: 1.0, cd: 16000, lastUsed: 0, type: 'atk', icon: 'â˜€ï¸' }
        ],
        mage: [
            { id: 'm1', name: "í™”ì—¼êµ¬", unlock: 2, mult: 9.0, ignoreDef: 0.6, cd: 5000, lastUsed: 0, type: 'magAtk', icon: 'ğŸ”¥' },
            { id: 'm2', name: "ëƒ‰ê¸° í­ë°œ", unlock: 5, mult: 18.0, ignoreDef: 0.8, cd: 8500, lastUsed: 0, type: 'magAtk', icon: 'â„ï¸' },
            { id: 'm3', name: "ê³µí—ˆ ì†Œí™˜", unlock: 8, mult: 65.0, ignoreDef: 1.0, cd: 22000, lastUsed: 0, type: 'magAtk', icon: 'ğŸŒŒ' }
        ],
        thief: [
            { id: 't1', name: "ê·¸ë¦¼ì ì°Œë¥´ê¸°", unlock: 2, mult: 10.0, ignoreDef: 0.8, cd: 3800, lastUsed: 0, type: 'atk', icon: 'ğŸ—¡ï¸' },
            { id: 't2', name: "ì¹˜ëª… ì•”ìŠµ", unlock: 5, mult: 16.0, ignoreDef: 0.9, cd: 6500, lastUsed: 0, type: 'atk', icon: 'ğŸ‘¥' },
            { id: 't3', name: "í™˜ì˜ ìŠµê²©", unlock: 8, mult: 55.0, ignoreDef: 1.0, cd: 13000, lastUsed: 0, type: 'atk', icon: 'âœ¨' }
        ]
    };

    const jobsData = {
        warrior: { name: 'ì „ì‚¬', atk: 350, def: 320, magAtk: 10, magDef: 200, hp: 12000 },
        mage: { name: 'ë§ˆë²•ì‚¬', atk: 60, def: 150, magAtk: 600, magDef: 400, hp: 6500 },
        thief: { name: 'ë„ì ', atk: 500, def: 200, magAtk: 150, magDef: 200, hp: 8500 }
    };

    const safeSetText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };

    function selectJob(id) {
        const j = jobsData[id];
        state.player = { ...state.player, job: id, jobName: j.name, baseAtk: j.atk, baseDef: j.def, baseMagAtk: j.magAtk, baseMagDef: j.magDef, maxHp: j.hp, hp: j.hp };
        const spr = document.getElementById('player-sprite-container');
        if(spr) spr.innerHTML = getHeroSVG(id, 90);
        safeSetText('p-job-display', j.name);
        document.getElementById('job-overlay').style.display = 'none';
        state.isInitialized = true;
        renderUpgrades(); renderSkills(); updateUI();
    }

    function toggleSpeed() {
        state.gameSpeed = state.gameSpeed === 1 ? 2.5 : 1;
        safeSetText('speed-btn', `SPEED x${state.gameSpeed}`);
    }

    function getCurrentStat(f) {
        const p = state.player;
        const bonus = f.includes('Atk') ? 120 : 100;
        const equip = (p.equipment.weapon?.[f] || 0) + (p.equipment.armor?.[f] || 0);
        return p['base' + f.charAt(0).toUpperCase() + f.slice(1)] + (p.upgrades[f] * bonus) + equip;
    }

    function updateUI() {
        if (!state.isInitialized) return;
        const p = state.player, w = state.world;
        const expReq = 10 * Math.pow(2.2, p.level - 1);

        safeSetText('p-level', p.level); safeSetText('p-gold', Math.floor(p.gold).toLocaleString() + ' G'); safeSetText('p-potions', p.potions);
        safeSetText('exp-text', `${Math.floor(p.exp)} / ${Math.floor(expReq)}`);

        const hs = document.getElementById('p-hp-bar-small'); if(hs) hs.style.width = (p.hp/p.maxHp*100) + '%';
        const eb = document.getElementById('exp-progress-bar'); if(eb) eb.style.width = (p.exp/expReq*100)+'%';

        safeSetText('p-atk', Math.floor(getCurrentStat('atk'))); safeSetText('p-def', Math.floor(getCurrentStat('def')));
        safeSetText('p-mag-atk', Math.floor(getCurrentStat('magAtk'))); safeSetText('p-mag-def', Math.floor(getCurrentStat('magDef')));

        safeSetText('chapter-display', `CHAPTER ${w.chapter}-${w.subStage}`);
        const sb = document.getElementById('stage-progress-bar'); if(sb) sb.style.width = (w.subStageKills*10)+'%';

        const theme = chapterBases[w.chapter].theme, bg = document.getElementById('battle-bg');
        if(bg && !bg.classList.contains(theme)) {
            ['bg-meadow','bg-ocean','bg-volcano','bg-wasteland','bg-castle'].forEach(t => bg.classList.remove(t));
            bg.classList.add(theme);
        }

        if (state.currentEnemy) {
            safeSetText('enemy-name', state.currentEnemy.name);
            const eh = document.getElementById('e-hp-bar'); if(eh) eh.style.width = (state.currentEnemy.hp/state.currentEnemy.maxHp*100)+'%';
            const es = document.getElementById('enemy-sprite'); if(es) es.innerText = state.currentEnemy.emoji;
            safeSetText('e-stat-atk', Math.floor(state.currentEnemy.atk)); safeSetText('e-stat-def', Math.floor(state.currentEnemy.def));
        }
        updateSkillsUI(); renderShop();
    }

    function renderUpgrades() {
        const c = document.getElementById('upgrade-list'); if(!c) return; c.innerHTML = '';
        [{id:'atk',n:'ë¬¼ë¦¬ ê³µê²©',c:'text-orange-400'},{id:'def',n:'ë¬¼ë¦¬ ë°©ì–´',c:'text-blue-400'},{id:'magAtk',n:'ë§ˆë²• ê³µê²©',c:'text-purple-400'},{id:'magDef',n:'ë§ˆë²• ë°©ì–´',c:'text-cyan-400'}].forEach(s => {
            const lv = state.player.upgrades[s.id], cost = 10 + (lv * 30);
            const div = document.createElement('div'); div.className = "flex justify-between items-center bg-slate-800/40 p-3 rounded-2xl border border-slate-700 shadow-sm";
            div.innerHTML = `<div><div class="text-[9px] font-black ${s.c} uppercase">${s.n}</div><div class="text-[7px] text-slate-500 font-bold uppercase tracking-widest">LV ${lv}</div></div><button onclick="buyUpgrade('${s.id}')" class="bg-indigo-700 hover:bg-indigo-600 px-4 py-1.5 rounded-xl text-[10px] font-black transition active:scale-95 text-white">${cost} G</button>`;
            c.appendChild(div);
        });
    }

    function renderSkills() {
        const c = document.getElementById('skill-container'); if(!c) return; c.innerHTML = '';
        jobSkills[state.player.job].forEach(sk => {
            const div = document.createElement('div'); div.id = `sk-${sk.id}`; div.className = "skill-slot opacity-20 shadow-xl";
            div.innerHTML = `<span class="text-2xl z-10">${sk.icon}</span><div id="cd-${sk.id}" class="absolute bottom-0 left-0 w-full bg-indigo-500/40 h-0"></div><div class="skill-level-badge">L.${sk.unlock}</div>`;
            c.appendChild(div);
        });
    }

    function updateSkillsUI() {
        const now = Date.now();
        jobSkills[state.player.job].forEach(sk => {
            const el = document.getElementById(`sk-${sk.id}`), cd = document.getElementById(`cd-${sk.id}`);
            if(!el || !cd) return;
            if(state.player.level >= sk.unlock) {
                el.classList.remove('opacity-20');
                const p = now - sk.lastUsed;
                if(p < sk.cd) { cd.style.height = (100 - (p/sk.cd*100))+'%'; el.classList.remove('skill-ready'); }
                else { cd.style.height = '0%'; el.classList.add('skill-ready'); }
            }
        });
    }

    function renderShop() {
        const c = document.getElementById('shop-items'); if(!c) return; c.innerHTML = '';
        state.shopItems.forEach(it => {
            const bought = state.boughtIds.includes(it.id), equip = (state.player.equipment.weapon?.id === it.id || state.player.equipment.armor?.id === it.id);
            const div = document.createElement('div'); div.className = `flex justify-between items-center bg-slate-800/40 p-3 rounded-2xl border border-slate-700 shadow-md ${bought?'opacity-50':''}`;
            div.innerHTML = `<div><div class="text-[10px] font-black text-slate-200">${it.name}</div><div class="text-[8px] text-indigo-400 font-bold uppercase">${it.atk?'PA+'+it.atk:''} ${it.magAtk?'MA+'+it.magAtk:''}</div></div><button onclick="buyItem('${it.id}')" class="${bought?'bg-slate-700':'bg-yellow-600'} px-4 py-2 rounded-xl text-[10px] font-black transition active:scale-95 text-white" ${bought&&equip?'disabled':''}>${bought?(equip?'ì°©ìš© ì¤‘':'êµì²´'):it.price+'G'}</button>`;
            c.appendChild(div);
        });
    }

    function buyPotion() { if(state.player.gold >= 10) { state.player.gold -= 10; state.player.potions += 5; updateUI(); } }

    function spawnEnemy() {
        if (!state.isInitialized || state.isMonsterEntering) return;
        const w = state.world, ch = chapterBases[w.chapter];

        // ìš”ì²­í•˜ì‹  ëª¬ìŠ¤í„° ì´ëª¨ì§€ ë¦¬ìŠ¤íŠ¸ ì ìš©
        const monsterList = [
            {n:'ê¹Œë§ˆê·€',e:'ğŸ¦â€â¬›',a:2.0,d:1.0,ma:2.5}, {n:'ë…ìˆ˜ë¦¬',e:'ğŸ¦…',a:2.5,d:1.2,ma:1.5},
            {n:'ë°•ì¥',e:'ğŸ¦‡',a:1.8,d:0.8,ma:3.0}, {n:'ê°œë¯¸',e:'ğŸœ',a:1.5,d:2.5,ma:0.5},
            {n:'ëª¨ê¸°',e:'ğŸ¦Ÿ',a:3.0,d:0.5,ma:1.0}, {n:'í‹°ë¼ë…¸',e:'ğŸ¦–',a:4.5,d:2.5,ma:1.5},
            {n:'ë±€',e:'ğŸ',a:2.2,d:1.1,ma:3.5}, {n:'ìƒì–´',e:'ğŸ¦ˆ',a:3.5,d:1.8,ma:1.0},
            {n:'ëŒê³ ë˜',e:'ğŸ¬',a:2.0,d:1.5,ma:4.0}, {n:'ê±°ë¶ì´',e:'ğŸ¢',a:1.0,d:5.0,ma:0.5},
            {n:'ì „ê°ˆ',e:'ğŸ¦‚',a:2.8,d:1.6,ma:2.0}, {n:'í˜¸ë‘ì´',e:'ğŸ…',a:3.2,d:1.4,ma:1.0},
            {n:'ì½”ë¿”ì†Œ',e:'ğŸ¦',a:3.0,d:3.5,ma:0.5}, {n:'ë§',e:'ğŸ',a:2.4,d:1.5,ma:1.0},
            {n:'ë§¤ë¨¸ë“œ',e:'ğŸ¦£',a:3.5,d:4.0,ma:2.0}, {n:'ìº¥ê±°ë£¨',e:'ğŸ¦˜',a:2.8,d:1.3,ma:1.5}
        ];

        // ì±•í„°ë³„ë¡œ ëœë¤í•˜ê²Œ ì„ íƒ (ì „ì²´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë¬´ì‘ìœ„ ì„ íƒ)
        const t = monsterList[Math.floor(Math.random() * monsterList.length)];
        const m = Math.pow(1.18, (w.chapter - 1) * 1.5 + (w.subStage * 0.12));

        state.currentEnemy = {
            name: t.n, emoji: t.e,
            maxHp: Math.floor(ch.hp * m), hp: Math.floor(ch.hp * m),
            atk: ch.atk * t.a * m, def: ch.def * (t.d || 1) * m,
            magAtk: ch.magAtk * (t.ma || 1) * m, magDef: ch.magDef * m,
            gold: ch.gold * m, exp: Math.max(1, m * 0.8)
        };

        state.isMonsterEntering = true;
        const node = document.getElementById('enemy-area');
        if(node) { node.classList.remove('monster-enter', 'opacity-0'); void node.offsetWidth; node.classList.add('monster-enter'); }
        setTimeout(() => { state.isMonsterEntering = false; }, 600); updateUI();
    }

    function battleTick() {
        if(state.isMonsterEntering) return;
        const p = state.player, curA = getCurrentStat('atk'), curD = getCurrentStat('def'), curMA = getCurrentStat('magAtk'), curMD = getCurrentStat('magDef');
        if(p.hp/p.maxHp <= 0.3 && p.potions > 0) { p.potions--; p.hp = Math.min(p.maxHp, p.hp+(p.maxHp * 0.5)); addLog(`ë¬¼ì•½ ìë™ ì‚¬ìš©! (50% íšŒë³µ)`, 'text-green-400 font-bold'); }

        const now = Date.now(), sks = jobSkills[p.job]; let sk = null;
        for(let i=sks.length-1; i>=0; i--) if(p.level >= sks[i].unlock && now-sks[i].lastUsed >= sks[i].cd) { sk = sks[i]; break; }

        let dmg = 0;
        if(sk) {
            const base = sk.type==='atk'?curA:curMA, td = sk.type==='atk'?state.currentEnemy.def:state.currentEnemy.magDef;
            dmg = Math.max(base * 1.5, (base * sk.mult) - (td * (1 - sk.ignoreDef)));
            sk.lastUsed = now; addLog(`${sk.name}! (${Math.floor(dmg)})`, 'text-indigo-400 font-black'); triggerVisual('burst');
        } else {
            dmg = Math.max(curA*0.35, curA-state.currentEnemy.def) + Math.max(curMA*0.35, curMA-state.currentEnemy.magDef); triggerVisual('slash');
        }

        state.currentEnemy.hp -= dmg; floatDamage('enemy', Math.floor(dmg));
        if(state.currentEnemy.hp <= 0) { handleVictory(); return; }

        setTimeout(() => {
            if(!state.currentEnemy) return;
            const ed = Math.max(state.currentEnemy.atk*0.05, state.currentEnemy.atk-curD) + Math.max(1, state.currentEnemy.magAtk-curMD);
            p.hp -= ed; floatDamage('player', Math.floor(ed)); updateUI();
        }, 300/state.gameSpeed);
    }

    function triggerVisual(type) {
        const node = document.getElementById(`${type}-effect`); if(!node) return;
        node.classList.remove(`${type}-active`); void node.offsetWidth; node.classList.add(`${type}-active`);
    }

    function floatDamage(target, val) {
        const cont = document.getElementById(target + '-damage-container'); if(!cont) return;
        const spr = document.getElementById(target==='player'?'player-sprite-container':'enemy-sprite');
        if(spr) { spr.classList.add('hit-effect'); setTimeout(() => spr.classList.remove('hit-effect'), 150); }
        const el = document.createElement('div'); el.className = `damage-float ${target==='player'?'text-red-500':'text-yellow-400'}`;
        el.innerText = `-${val}`; el.style.left = `${Math.random()*40+30}%`;
        cont.appendChild(el); setTimeout(() => el.remove(), 800);
    }

    function handleVictory() {
        const e = state.currentEnemy, p = state.player, w = state.world;
        p.gold += e.gold; p.exp += e.exp; addLog(`${e.name} ì²˜ì¹˜ (+${Math.floor(e.gold)}G)`, 'text-slate-500');
        const req = 10 * Math.pow(2.2, p.level - 1);
        if(p.exp >= req) {
            p.level++; p.exp = 0; p.maxHp += 3000; p.hp = p.maxHp;
            p.baseAtk += 200; p.baseMagAtk += 200; p.baseDef += 150; p.baseMagDef += 150;
            addLog(`LEVEL UP! Lv.${p.level} ì˜ì›… ê°ì„±!`, 'text-yellow-400 font-black'); renderUpgrades();
        }
        w.totalKills++; w.subStageKills++;
        if(w.subStageKills >= 10) {
            w.subStage++; w.subStageKills = 0;
            if(w.subStage > 10 && w.chapter < w.maxChapters) { w.chapter++; w.subStage = 1; addLog(`ì°¨ì› ì´ë™! ì±•í„° ${w.chapter} ì§„ì…`, 'text-indigo-400 font-black'); }
        }
        state.currentEnemy = null; document.getElementById('enemy-area').classList.add('opacity-0'); updateUI();
    }

    function handleDefeat() {
        addLog(`ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤... êµ¬ì—­ ì´ˆê¸°í™”.`, 'text-red-600 font-black');
        state.player.hp = state.player.maxHp; state.world.subStageKills = 0; state.currentEnemy = null;
        document.getElementById('enemy-area').classList.add('opacity-0'); updateUI();
    }

    function addLog(m, c = 'text-slate-500') {
        const log = document.getElementById('battle-log'); if(!log) return;
        const el = document.createElement('div'); el.className = c; el.innerText = `> ${m}`;
        log.prepend(el); if(log.children.length > 25) log.removeChild(log.lastChild);
    }

    function buyUpgrade(id) {
        const lv = state.player.upgrades[id], cost = 10 + (lv * 30);
        if(state.player.gold >= cost) { state.player.gold -= cost; state.player.upgrades[id]++; renderUpgrades(); updateUI(); }
    }

    function buyItem(id) {
        const it = state.shopItems.find(i => i.id === id);
        if(it && !state.boughtIds.includes(id) && state.player.gold >= it.price) {
            state.player.gold -= it.price; state.boughtIds.push(id); state.player.equipment[it.type] = it;
            addLog(`${it.name} ì¥ì°©!`, 'text-yellow-500 font-black'); updateUI();
        } else if(it && state.boughtIds.includes(id)) { state.player.equipment[it.type] = it; updateUI(); }
    }

    function switchTab(t) {
        ['combat', 'upgrade', 'shop'].forEach(x => {
            const p = document.getElementById(`panel-${x}`), b = document.getElementById(`btn-${x}`);
            if(p) p.classList.add('hidden'); if(b) { b.classList.replace('bg-indigo-600', 'bg-slate-800'); b.classList.add('text-indigo-300'); }
        });
        const tp = document.getElementById(`panel-${t}`), tb = document.getElementById(`btn-${t}`);
        if(tp) tp.classList.remove('hidden'); if(tb) { tb.classList.replace('bg-slate-800', 'bg-indigo-600'); tb.classList.remove('text-indigo-300'); }
    }

    let lastTick = Date.now();
    function loop() {
        const now = Date.now(); if(!state.isInitialized) { requestAnimationFrame(loop); return; }
        if(state.player.hp <= 0) handleDefeat();
        else if(state.currentEnemy) { if(now - lastTick >= (850 / state.gameSpeed)) { battleTick(); lastTick = now; } }
        else spawnEnemy();
        updateSkillsUI(); requestAnimationFrame(loop);
    }

    window.onload = () => {
        ['warrior', 'mage', 'thief'].forEach(j => {
            const el = document.getElementById(`preview-${j}`);
            if(el) el.innerHTML = getHeroSVG(j, 70);
        });
        requestAnimationFrame(loop);
    };
</script>
</body>
</html>